<!DOCTYPE html>
<html>
  <head>
    <title>Managing Containers with Ansible</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3, h4 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }

      .remark-slide-content { font-size: 1.6em; }
      .remark-slide-content h1 { font-size: 2.4em; }
      .remark-slide-content h2 { font-size: 2.0em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .remark-slide-content h4 { font-size: 1.2em; }
      .remark-code { font-size: 0.9em; }
      .remark-slide-number { font-size: 0.8em; }
      .remark-slide-content ul { line-height: 1.4em; }

      .small { font-size: 0.7em; }
      .columns-3-ul ul { columns: 3; }

      img { max-width: 100%; }
      blockquote {
        font-style: italic;
        color: #777;
      }
    </style>
    <script src="https://use.fontawesome.com/1a2bc43b60.js"></script>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Managing Containers with Ansible
### Peter Schiffer, Tomáš Tomeček
#### [github.com/pschiffe/ansible-docker](https://github.com/pschiffe/ansible-docker)

---

# Agenda

* Ansible crash course
* Containers with Ansible
* ~~Building images~~
* But I have Docker Compose already

---

# Why?

* Ansible is very powerful

--

* Suitable for any scale

--

  * But for über-scale you should get Ansible Tower

--

  * Content of this talk is for small to mid-scale

---

exclude: true
# Skills poll

* Who already created container with Docker?

--
exclude: true
* Who created custom image for Docker?

--
exclude: true
* Who used Docker on more than 10 servers (vps)?

--
exclude: true
* Who already used Ansible?

--
exclude: true
* Who used Ansible on more than 10 servers (vps)?

--
exclude: true
* Who used Kubernetes?

---

exclude: true
# Prerequisites

```bash
sudo dnf install ansible docker python-docker-py
sudo systemctl start docker
```

```bash
sudo docker pull gogs/gogs:0.9.113
sudo docker pull rroemhild/mailpile
sudo docker pull mongo:3.4
sudo docker pull rocket.chat
sudo docker pull eeacms/haproxy
sudo docker pull eeacms/hello
sudo docker pull fedora:25
sudo docker pull nginx:1.10-alpine
sudo docker pull mariadb:10.1
```

---

class: center, middle

# Ansible

---

# First steps

## Installation on Fedora

```bash
$ sudo dnf install ansible python-docker-py docker docker-compose
```

--

## First command
```bash
$ ansible localhost -m ping
 [WARNING]: provided hosts list is empty, only localhost is available

localhost | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

---

# Inventory

```yaml
[all]
localhost   ansible_connection=local  ansible_become=false
foo   ansible_host=foo.example.com   ansible_port=2222   ansible_user=centos

[webservers]
foo
www[01:50].example.com
```

--

## Dynamic Inventory

```bash
$ source openstack.rc
$ ansible -i openstack.py all -m ping
```

???

Inventory directory, output of dynamic inventory scripts

---

# Task

<pre><code class="yaml hljs remark-code"><div class="remark-code-line">- name: install apache package

</div></code></pre>

---

# Task

```yaml
- name: install apache package
* yum:
```

---

# Task

```yaml
- name: install apache package
* yum: name=      state=
```

---

# Task

```yaml
- name: install apache package
* yum: name=httpd state=present
```

---

# Task

```yaml
- name: install apache package
  yum: name=httpd state=present
```

```yaml
- name: install apache package
  yum:
    name: httpd
    state: present
```

---

# Task

```yaml
- name: install apache package
  yum: name=httpd state=present
* tags:
*   - installation
*   - web-server
```

```yaml
- name: install apache package
  yum:
    name: httpd
    state: present
* tags:
*   - installation
*   - web-server
```

---

# Available modules

1000+ modules: [docs.ansible.com/ansible/modules_by_category.html](https://docs.ansible.com/ansible/modules_by_category.html)

```yaml
yum, apt, package, pip, template, file, service, command, shell, nmcli..
```

## Categories

.columns-3-ul[
* Cloud
* Clustering
* Commands
* Crypto
* Database
* Files
* Identity
* Inventory
* Messaging
* Monitoring
* Network
* Notification
* Packaging
* Remote Management
* Source Control
* Storage
* System
* Utilities
* Web Infrastructure
* Windows
]

---

# Playbook

<pre><code class="yaml hljs remark-code"><div class="remark-code-line">- name: install and configure web servers
  hosts: webservers



  tasks:
    - name: install apache package
      yum: name=httpd state=present
    - name: write the apache config file
      template: src=t/httpd.j2 dest=/etc/httpd.conf


    - name: ensure apache is running (and enable it at boot)
      service: name=httpd state=started enabled=yes



</div></code></pre>

---

# Playbook

```yaml
- name: install and configure web servers
  hosts: webservers



  tasks:
    - name: install apache package
      yum: name=httpd state=present
    - name: write the apache config file
      template: src=t/httpd.j2 dest=/etc/httpd.conf
*     notify:
*       - restart apache
    - name: ensure apache is running (and enable it at boot)
      service: name=httpd state=started enabled=yes
* handlers:
*   - name: restart apache
*     service: name=httpd state=restarted
```

---

# Playbook

```yaml
- name: install and configure web servers
  hosts: webservers
* vars:
*   http_port: 80
*   max_clients: 200
  tasks:
    - name: install apache package
      yum: name=httpd state=present
    - name: write the apache config file
      template: src=t/httpd.j2 dest=/etc/httpd.conf
      notify:
        - restart apache
    - name: ensure apache is running (and enable it at boot)
      service: name=httpd state=started enabled=yes
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
```

---

# Variables

```yaml
- name: configure web servers
  hosts: webservers
  vars:
    apache_listen_port: 80
    apache_vhosts:
      - servername: go.example.com
        documentroot: /var/www/html/go
      - servername: rust.example.com
        documentroot: /var/www/html/rust
        serveralias: default.example.com
  tasks:
    - name: write the apache config file
      template: src=t/httpd.j2 dest={{ apache_conf | default('/etc/httpd.conf') }}
```

---

# Variables

```yaml
- name: configure web servers
  hosts: webservers
  vars:
*   apache_listen_port: 80
    apache_vhosts:
      - servername: go.example.com
        documentroot: /var/www/html/go
      - servername: rust.example.com
        documentroot: /var/www/html/rust
        serveralias: default.example.com
  tasks:
    - name: write the apache config file
      template: src=t/httpd.j2 dest={{ apache_conf | default('/etc/httpd.conf') }}
```

---

# Variables

```yaml
- name: configure web servers
  hosts: webservers
  vars:
    apache_listen_port: 80
*   apache_vhosts:
*     - servername: go.example.com
*       documentroot: /var/www/html/go
*     - servername: rust.example.com
*       documentroot: /var/www/html/rust
*       serveralias: default.example.com
  tasks:
    - name: write the apache config file
      template: src=t/httpd.j2 dest={{ apache_conf | default('/etc/httpd.conf') }}
```

---

# Variables

```yaml
- name: configure web servers
  hosts: webservers
  vars:
    apache_listen_port: 80
    apache_vhosts:
      - servername: go.example.com
        documentroot: /var/www/html/go
      - servername: rust.example.com
        documentroot: /var/www/html/rust
        serveralias: default.example.com
  tasks:
    - name: write the apache config file
*     template: src=t/httpd.j2 dest={{ apache_conf | default('/etc/httpd.conf') }}
```

Filters: [docs.ansible.com/ansible/playbooks_filters.html](https://docs.ansible.com/ansible/playbooks_filters.html)

---

# Templates (httpd.j2)

```django
{# Set up VirtualHosts #}
{% for vhost in apache_vhosts %}
<VirtualHost {{ apache_listen_ip | default('*') }}:{{ apache_listen_port }}>
  ServerName {{ vhost.servername }}
{% if vhost.serveralias is defined %}
  ServerAlias {{ vhost.serveralias }}
{% endif %}
{% if vhost.documentroot is defined %}
  DocumentRoot {{ vhost.documentroot }}
{% endif %}
</VirtualHost>
{% endfor %}
```

---

# Templates (httpd.j2)

```django
*{# Set up VirtualHosts #}
{% for vhost in apache_vhosts %}
<VirtualHost {{ apache_listen_ip | default('*') }}:{{ apache_listen_port }}>
  ServerName {{ vhost.servername }}
{% if vhost.serveralias is defined %}
  ServerAlias {{ vhost.serveralias }}
{% endif %}
{% if vhost.documentroot is defined %}
  DocumentRoot {{ vhost.documentroot }}
{% endif %}
</VirtualHost>
{% endfor %}
```

---

# Templates (httpd.j2)

```django
{# Set up VirtualHosts #}
*{% for vhost in apache_vhosts %}
<VirtualHost {{ apache_listen_ip | default('*') }}:{{ apache_listen_port }}>
  ServerName {{ vhost.servername }}
{% if vhost.serveralias is defined %}
  ServerAlias {{ vhost.serveralias }}
{% endif %}
{% if vhost.documentroot is defined %}
  DocumentRoot {{ vhost.documentroot }}
{% endif %}
</VirtualHost>
*{% endfor %}
```

---

# Templates (httpd.j2)

```django
{# Set up VirtualHosts #}
{% for vhost in apache_vhosts %}
<VirtualHost {{ apache_listen_ip | default('*') }}:{{ apache_listen_port }}>
  ServerName {{ vhost.servername }}
*{% if vhost.serveralias is defined %}
  ServerAlias {{ vhost.serveralias }}
*{% endif %}
*{% if vhost.documentroot is defined %}
  DocumentRoot {{ vhost.documentroot }}
*{% endif %}
</VirtualHost>
{% endfor %}
```

---

# Templates (httpd.j2)

```django
{# Set up VirtualHosts #}
{% for vhost in apache_vhosts %}
*<VirtualHost {{ apache_listen_ip | default('*') }}:{{ apache_listen_port }}>
* ServerName {{ vhost.servername }}
{% if vhost.serveralias is defined %}
* ServerAlias {{ vhost.serveralias }}
{% endif %}
{% if vhost.documentroot is defined %}
* DocumentRoot {{ vhost.documentroot }}
{% endif %}
</VirtualHost>
{% endfor %}
```

---

# Control structures (when)

```yaml
- name: install apache package on Red Hat distro
  yum: name=httpd state=present
* when: ansible_os_family == 'RedHat'

- name: install apache package on Debian distro
  apt: name=apache2 state=present
* when: ansible_os_family == 'Debian'
```

---

# Control structures (with_items)

```yaml
- name: install apache package on Red Hat distro
* yum: name={{ item }} state=present
  when: ansible_os_family == 'RedHat'
* with_items:
*   - httpd
*   - mod_ssl

- name: install apache package on Debian distro
* apt: name={{ item }} state=present
  when: ansible_os_family == 'Debian'
* with_items:
*   - apache2
*   - apache2-utils
```

---

# Roles (directory structure)

```bash
site.yml
webservers.yml
fooservers.yml
roles/
  webservers/
    files/
    templates/
    tasks/
      main.yml
    handlers/
      main.yml
    vars/
    defaults/
      main.yml
    meta/
```

---

# Roles (directory structure)

```bash
*site.yml
*webservers.yml
*fooservers.yml
roles/
  webservers/
    files/
    templates/
    tasks/
      main.yml
    handlers/
      main.yml
    vars/
    defaults/
      main.yml
    meta/
```

---

# Roles (directory structure)

```bash
site.yml
webservers.yml
fooservers.yml
roles/
* webservers/
    files/
    templates/
    tasks/
      main.yml
    handlers/
      main.yml
    vars/
    defaults/
      main.yml
    meta/
```

---

# Roles (directory structure)

```bash
site.yml
webservers.yml
fooservers.yml
roles/
  webservers/
    files/
    templates/
    tasks/
*     main.yml
    handlers/
*     main.yml
    vars/
    defaults/
*     main.yml
    meta/
```

---

# Roles (in playbook)

```yaml
- name: deploy webservers
  hosts: webservers
  roles:
    - common
    - webservers
```

---

class: center, middle

# Ansible <span class="fa fa-heart" aria-hidden="true"></span> Containers

---

# Docker modules

* [docker_container](http://docs.ansible.com/ansible/docker_container_module.html) - manage Docker containers
* [docker_network](http://docs.ansible.com/ansible/docker_network_module.html) - manage Docker networks
* [docker_image](http://docs.ansible.com/ansible/docker_image_module.html) - manage Docker images
* [docker_service](http://docs.ansible.com/ansible/docker_service_module.html) - utilize Docker Compose

Documentation: [docs.ansible.com/ansible/list_of_cloud_modules.html#docker](https://docs.ansible.com/ansible/list_of_cloud_modules.html#docker)

---

# Simple container: gitea (gogs fork)

```yaml
---
- name: create gitea container
  hosts: localhost
  tasks:
    - name: create gitea container
      docker_container:
        name: my-gitea
        image: gitea/gitea:1.1
        state: started    # absent, present, stopped
        published_ports:
          - '10022:22'
          - '3000:3000'
        volumes:
          - my-gitea-data:/data:z
```
```bash
$ ansible-playbook gitea/gitea.yml
```

---

# Simple container: gitea (gogs fork)

```yaml
- name: create gitea container
  hosts: localhost
* vars:
*   c_state: started
  tasks:
    - name: create gitea container
      docker_container:
        name: my-gitea
        image: gitea/gitea:1.1
*       pull: true
*       state: '{{ c_state }}'
*       restart_policy: always
        published_ports:
          - '10022:22'
          - '3000:3000'
        volumes:
*         - /etc/localtime:/etc/localtime:ro
          - my-gitea-data:/data:z
```
```bash
$ ansible-playbook gitea/gitea.yml -e c_state=absent
```

---

# Simple container: gitea (gogs fork)

```yaml
- name: create gitea container
  hosts: localhost
  vars:
*   wipe: false
*   c_state: '{{ "absent" if wipe | bool else "started" }}'
*   c_name: my-gitea
  tasks:
    - name: create gitea container
      docker_container:
*       name: '{{ c_name }}'
        image: gitea/gitea:1.1
        state: '{{ c_state }}'
        volumes:
*         - '{{ c_name }}-data:/data:z'
*   - name: remove docker volume
*     command: docker volume rm {{ c_name }}-data
*     ignore_errors: true
*     when: wipe | bool
```
```bash
$ ansible-playbook gitea/gitea.yml -e wipe=true
```

---

# Multiple containers of one kind - mailpile

```yaml
$ cat container.yml
- name: create mailpile container
  docker_container:
    name: '{{ c_name }}'
    image: rroemhild/mailpile
    pull: true
    state: '{{ c_state }}'
    restart_policy: always
    published_ports:
*     - '{{ c_port }}:33411'
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - '{{ c_name }}-data:/root/.local/share/Mailpile:z'

- name: remove docker volume
  command: docker volume rm {{ c_name }}-data
  ignore_errors: true
  when: wipe | bool
```

---

# Multiple containers of one kind - mailpile

```yaml
- name: create mailpile containers
  hosts: localhost
  vars:
    wipe: false
    c_state: '{{ "absent" if wipe | bool else "started" }}'
    containers:
      - name: john
        port: '21111'
      - name: pete
        port: '21112'
      - name: jake
        port: '21113'
  tasks:
    - name: create mailpile containers
      include: container.yml
      vars:
        c_name: 'mailpile-{{ item.name }}'
        c_port: '{{ item.port }}'
      with_items: '{{ containers }}'
```

---

# Networking and connection: docker - Rocket.Chat

```yaml
- name: create mongodb container for rocketchat
  hosts: localhost
  tasks:
    - name: create network for rocketchat
      docker_network:
        name: '{{ c_name }}'
        state: present

    - name: create mongodb for rocketchat container
      docker_container:
        name: '{{ c_name }}-mongo'
        image: pschiffe/mongo-ansible
        state: '{{ c_state }}'
        purge_networks: true
        networks:
          - name: '{{ c_name }}'
            aliases:
              - db
              - mongo

    - meta: refresh_inventory
```

---

# Networking and connection: docker - Rocket.Chat

```yaml
- name: create db users in mongodb container
  hosts: '{{ c_name }}-mongo'
  connection: docker
  vars:
    mongo_admin: admin
    mongo_admin_pass: password1
    rocket_user: rocket
    rocket_password: password2
  tasks:
    - name: create rocket user
      mongodb_user:
        login_user: '{{ mongo_admin }}'
        login_password: '{{ mongo_admin_pass }}'
        database: '{{ rocket_user }}'
        name: '{{ rocket_user }}'
        password: '{{ rocket_password }}'
        roles:
          - db: '{{ rocket_user }}'
            role: readWrite
        state: present
```

---

# Networking and connection: docker - Rocket.Chat

```yaml
- name: create rocketchat container
  hosts: localhost
  tasks:
    - name: create rocketchat container
      docker_container:
        name: '{{ c_name }}'
        image: rocket.chat
        state: '{{ c_state }}'
        purge_networks: true
        networks:
          - name: '{{ c_name }}'
        env:
          MONGO_URL: 'mongodb://{{ rocket_user }}:{{ rocket_password }}@db:27017/{{ rocket_user }}'
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - '{{ c_name }}-data:/app/uploads:z'

    - name: remove network
      docker_network:
        name: '{{ c_name }}'
        state: absent
      ignore_errors: true
      when: wipe | bool
```

---

class: center, middle

# So what about Docker Compose?

---

# Docker Compose

```yaml
haproxy:
  image: eeacms/haproxy:1.7-3.0
  links:
    - first_webapp
    - second_webapp
    - third_app
  ports:
    - "5000:5000"
    - "1936:1936"
  environment:
    - SERVICE_NAMES=webapp

first_webapp:
  image: eeacms/hello

second_webapp:
  image: eeacms/hello

third_app:
  image: eeacms/hello
```

---

# Ansible Playbook

```yaml
---
- name: example ansible docker service
  hosts: localhost
  vars:
    wipe: false
    c_state: '{{ "absent" if wipe | bool else "present" }}'
  tasks:
    - name: create containers from docker compose
      docker_service:
        project_src: .
        state: '{{ c_state }}'
```

---

class: center, middle

# Q &amp; A?
#### [github.com/pschiffe/ansible-docker](https://github.com/pschiffe/ansible-docker)
#### <span class="fa fa-linkedin-square"></span> [Peter Schiffer](https://www.linkedin.com/in/peterschiffer/)
#### <span class="fa fa-twitter-square"></span> [Tomáš Tomeček](https://twitter.com/TomasTomec)


    </textarea>
    <script src="remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightLines: true
      });
    </script>
  </body>
</html>
